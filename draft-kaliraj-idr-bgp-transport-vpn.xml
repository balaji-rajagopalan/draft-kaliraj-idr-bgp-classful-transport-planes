<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd">
<?rfc toc="yes"?>
<?rfc tocompact="yes"?>
<?rfc tocdepth="3"?>
<?rfc tocindent="yes"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>
<?rfc comments="yes"?>
<?rfc inline="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>
<rfc category="exp" docName="draft-kaliraj-idr-bgp-transport-vpns-00"
     ipr="trust200902">
  <front>
    <title abbrev="BGP Transport VPNs">BGP Transport VPNs</title>

    <author fullname="Kaliraj Vairavakkalai" initials="K."
            surname="Vairavakkalai">
      <organization>Juniper Networks, Inc.</organization>

      <address>
        <postal>
          <street>1133 Innovation Way,</street>

          <city>Sunnyvale</city>

          <region>CA</region>

          <code>94089</code>

          <country>US</country>
        </postal>

        <email>kaliraj@juniper.net</email>
      </address>
    </author>

    <author fullname="Natarajan Venkataraman" initials="N."
            surname="Venkataraman">
      <organization>Juniper Networks, Inc.</organization>

      <address>
        <postal>
          <street>1133 Innovation Way,</street>

          <city>Sunnyvale</city>

          <region>CA</region>

          <code>94089</code>

          <country>US</country>
        </postal>

        <email>natv@juniper.net</email>
      </address>
    </author>

    <author fullname="Balaji Rajagopalan" initials="B." surname="Rajagopalan">
      <organization>Juniper Networks, Inc.</organization>

      <address>
        <postal>
          <street>Electra, Exora Business Park~Marathahalli - Sarjapur Outer
          Ring Road,</street>

          <city>Bangalore</city>

          <region>KA</region>

          <code>560103</code>

          <country>India</country>
        </postal>

        <email>balajir@juniper.net</email>
      </address>
    </author>

    <author/>

    <date day="29" month="December" year="2019"/>

    <abstract>
      <t>This document specifies a mechanism, referred to as "service mapping",
      to express association of overlay routes with underlay routes using
      BGP. The document describes a framework for service mapping, and specifies
      BGP protocol procedures that enable dissimineation of the service mapping
      information that can potentially cross administrative domains</t>
      
      <t>A new BGP transport address family is defined for this purpose that
      uses BGP-VPN technology (RFC 4364) and follows RLI-8277 NLRI encoding.
      This new address family is called "Transport VPNs".</t>
    </abstract>

    <note title="Requirements Language">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <xref
      target="RFC2119">RFC 2119</xref>.</t>
    </note>
  </front>

  <middle>
    <section title="Introduction">
      <t>To facilitate service mapping, the tunnels in a network can be grouped
      by the purpose they serve into a "transport class". The tunnels could be
      created using any existing signaling protocol, such as LDP, RSVP, BGP-LU
      or SPRING. The tunnels could also use native IP or IPv6, as long as the
      tunnels can carry MPLS payload.</t>

      <t>Thus, a transport class consists of tunnels created by many protocols
      terminating in varios nodes, each satisfying the properties of the
      class. For example, a "Gold" transport class may consist of tunnels that
      traverse the shortest path with fast re-route protection, a "Silver"
      transport class may hold tunnels that traverse shortest paths without
      protection, a "Bronze" transport class may hold tunnels that are not
      guaranteed to traverse the shortest path, and so on.</t>

      <t>The extensions specified in this document can be used to create a BGP
      transport tunnel that potentially spans domains, while preserving its
      transport class.  Examples of domain are Autonomous System (AS), or IGP
      area. Within each domain, there is a second level underlay LSP used by BGP
      to cross the domain. The second level underlay LSPs could be hetrogeneous:
      Each domain may use a different type of tunnel, or use a differnet
      signaling protocol. A domain boundary is demarcated by a rewrite of BGP
      nexthop to 'self' while re-advertising tunnel routes in BGP. The path uses
      MPLS label-switching when crossing inter-AS links and uses the native
      intra-AS tunnel of the desired traffic class when traversing within a
      domain.</t>

      <t>Overlay routes carry sufficient indication of the transport class they
      should be encapsulated over. A "route resolution" procedure on the ingress
      node selects from the transport class an appropriate tunnel whose
      destination matches the nexthop of the overlay route. If the overlay route
      is carried in BGP, the protocol nexthop (or, PNH) is generally carried as
      an attribute of the route.  The PNH of the overlay route is also referred
      to as "service endpoint".  The service endpoint may exist in the same
      domain as the service ingress node or lie in a different domain, adjacent
      or non-adjacent.</t>

      <t>This document describes mechanisms to: <list>
          <t>Model a "transport class" as "transport RIB" consisting of tunnel
          ingress routes of a certain class.</t>

          <t>Enable service routes to resolve over an intended transport class
          by using the corresponding transport RIB for finding nexthop
          reachability.</t>

          <t>Advertise tunnel ingress routes of a transport RIB to other domains
          without any path hiding, using BGP VPN technology and Add-path, such
          that overlay routes in the receiving domains can also resolve over
          tunnels of the same transport class.</t>

          <t>Provide a way for co-operating domains to reconcile between
          independently administered extended community namespaces, and
          interoperate between different transport signaling protocols in each
          domain.</t>
        </list></t>

      <t>In this document we focus mainly on MPLS LSPs as transport tunnels, but
      the mechanisms would work in similar manner for non-MPLS transport tunnels
      too, provided the tunnel can carry MPLS payload.</t>
    </section>

    <section title="Terminology">
      <t>LSP: Label Switched Path</t>

      <t>TE : Traffic Engineering</t>

      <t>SN : Service Node</t>

      <t>BN : Border Node</t>

      <t>TN : Transport Node, P-router</t>

      <t>BGP-VPN : VPNs built using RFC-4364 mechanisms</t>

      <t>RT : Route-Target extended community</t>

      <t>RD : Route-Distinguisher</t>

      <t>PNH : Protocol-Nexthop</t>

      <t>Service Family : BGP address family used for advertising routes for
      "data traffic", as opposed to tunnels</t>

      <t>Transport Family : BGP address family used for advertising tunnels,
      which are in turn used by service routes for resolution</t>

      <t>Transport Tunnel : A tunnel over which a service may place
      traffic. These tunnels can be GRE, UDP, LDP, RSVP, or SR-TE</t>

      <t>Tunnel Domain : A domain of the network containing SN and BN, under a
      single administrative control that has a tunnel between SN and BN. An
      end-to-end tunnel spanning several adjacent tunnel domains can be
      created by "stitching" them together using labels.</t>

      <t>Transport Class : A group of transport tunnels offering the same type of service.</t>

      <t>Transport Class RT : A BGP-VPN Route-Target used to identify a
      specific transport class</t>

      <t>Transport RIB : At the SN and BN, a transport class has an associted
      transport RIB that holds its tunnel routes.</t>

      <t>Transport-VPN : Set of Transport-RTIs importing same
      TransportClass-RT. Across tunnel domain boundaries these are stitched
      together using option-b(nexthop-self, label-swap)-like mechanism.</t>

      <t>Mapping-Community : Community on a service route, that maps it to
      resolve over a Transport-class</t>
    </section>

    <section title="Transport Class">
      <t>A transport class is defined as a collection of transport tunnels that
      share certain characteristics useful for underlay selection.</t>

      <t>On the wire, a transport class is represented as the
      transport class Route-Target, which is a regular Route-Target
      extended community.</t>

      <t>A transport class is configured at SN and BN, along with attributes
      like RD and Route-Target. The transport class instantiates a
      transport RIB and transport routing instance.</t>

      <t>The operator may configure a BN to classify a tunnel into an
      appropriate transport class, which causes the tunnel's routes to be
      installed in the corresponding transport RIB. These tunnel routes may then
      be advertised into BGP.</t>

      <t>Alternatively, the transport routes received in BGP with appropriate
      signaling information can associate those ingress routes to the
      appropriate transport class. E.g. for TransportVpn family(SAFI 75)
      routes, the TransportClass-RT indicates the transport class. For BGP-LU
      family(SAFI 4) routes, import policy based on Communities or inter-AS
      source-peer may be used to place the route in the desired
      transport class.</t>

      <t>When the ingress route is received via [BGP-SRTE], which encodes the
      transport-class as an integer "Color" in the NLRI as "Color:Endpoint",
      the color can be mapped to a transport class community, or Route-Target by
      the receiving router, so that the ingress route for "Endpoint" is
      installed in the transport RIB for the transport class. The BGP-SRTE
      route when advertised out to BGP speakers in other domains will be
      advertised in Transport-VPN family with TransportClass-RT and a new
      label. The MPLS swap route thus installed for the new label will pop the
      label and deliver decapsulated-traffic into the path determined by SRTE
      route.</t>
    </section>

    <section title="Transport RIB">
      <t>A transport RIB is a routing-only RIB that is not installed in
      forwarding path. However, the routes in this RIB are used to resolve
      reachability of overlay routes' PNH. Transport RIBs are created when
      the transport classes are configured.</t>

      <t>Overlay routes that want to use a specific transport class confine the
      scope of nexthop resolution to the set of routes contained in the
      corresponding transport RIB</t>

      <t>Routes in a transport rib are exported out in 'Transport VPN'
      address family.</t>
    </section>

    <section title="Transport Routing Instance">
      <t>A BGP VPN routing instance is a container for the transport RIBs.
      It imports, and exports routes with TransportClass-RT. Tunnel destination
      addresses in this routing instance's context come from the
      "provider namespace". This is different from user VRFs, which contain
      prefixes in "customer namespace"</t>

      <t>The transport routing instance uses the RD and routing instance
      configured for the transport class.</t>
    </section>

    <section title="Nexthop Resolution Scheme">
      <t>An implementation may provide an option for the service route to
      resolve over less preferred transport RIBs, should resolution over
      preferred, or "primary" transport RIB fail. To accomplish this, each
      transport class may be associated with a user-configured "resolution
      scheme", which consists of the primary transport RIB, and an ordered list
      of fallback transport RIBs.</t>

      <t>A route received in BGP Transport VPN family can be associated with a
      resolution scheme using import policies. The import policies can match
      against "mapping community", a community or "set of attributes" on the
      service route that maps to a resolution scheme. When a route is received
      with this attribute, it signifies the resolution scheme to use when
      resolving the route's PNH.</t>
    </section>

    <section title="Transport-VPN BGP Family NLRI">
      <t>The Transport-VPN family will use the existing AFI of IPv4 or IPv6, and
      a new SAFI "TransportVpn" that will apply to both IPv4 and IPv6.</t>

      <t>The NLRI encoding is exactly the same as RFC-4364 (AFI/SAFI = 1/128
      or 2/128) as stated in Fig 1.</t>

      <figure>
        <artwork> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Length     |                 Label                 |Rsrv |S|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          RD                                   ~
~                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Prefix                               ~
~                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

          Figure 1: TransportVpn NLRI

- Length:

    The Length field consists of a single octet.  It specifies the
    length in bits of the remainder of the NLRI field.

    Note that the length will always be the sum of 20 (number of bits
    in Label field), plus 3 (number of bits in Rsrv field), plus 1
    (number of bits in S field), plus the length in bits of the
    prefix.

    In an MP_REACH_NLRI attribute whose SAFI is TBD, the prefix will
    be 96 bits or less if the AFI is 1 and will be 192 bits or less
    if the AFI is 2.

    As specified in [RFC4760], the actual length of the NLRI field
    will be the number of bits specified in the Length field, 
    rounded up to the nearest integral number of octets.

- Label:

    The Label field is a 20-bit field containing an MPLS label value
    (see [RFC3032]).

- Rsrv:

    This 3-bit field SHOULD be set to zero on transmission and MUST
    be ignored on reception.

- S:

    This 1-bit field MUST be set to one on transmission and MUST be
    ignored on reception.</artwork>
      </figure>

      <t>Attributes on a Transport-VPN route include the Route-Target
      extended community, which is used to leak the route into the right
      transport RIBs on SNs and BNs in the network.</t>

      <t>We use a new AFI/SAFI instead of re-using SAFI 128 to carry these
      transport routes, because it is operationally advantageous to keep
      transport and service prefixes separate, and not mix in the same address
      family. It allows to safely enable per-prefix-label allocation for
      transport-VPN prefixes while not affecting SAFI 128 service
      prefixes. Also, transport family re-advertisement path in a network would
      be different than service route readvertisement path. viz.  Service routes
      are exchanged over a EBGP multihop session between autonomous systems with
      nexthop unchanged, while transport-VPN routes will need to be readvertised
      over EBGP single-hop sessions with nexthop-self rewrite over inter-AS
      links.</t>
    </section>

    <section title="Comparison with other families using RFC-8277 encoding">
      <t>SAFI 128 (InetVpn) is a RFC-8277 encoded family that carries
      service prefixes in the NLRI, where the prefixes come from the customer
      namespaces, and are contexualized into separate user virtual
      service RIBs called VRFs, using RFC-4364 procedures.</t>

      <t>SAFI 4 (BGP-LU) is a RFC-8277 encoded family that carries
      transport prefixes in the NLRI, where the prefixes come from the
      provider namespace.</t>

      <t>SAFI 75 (TransportVpn) is a RFC-8277 encoded family that carries
      transport prefixes in the NLRI, where the prefixes come from the
      provider namespace, but are contexualized into separate transport RIBs,
      using RFC-4364 procedures.</t>

      <t>It is worth noting that SAFI 128 has been used to carry
      transport prefixes in "L3VPN Inter-AS Carrier's carrier" scenario, where
      BGP-LU/LDP prefixes in CsC VRF are advertised in SAFI 128 to the
      remote-end baby carrier. </t>

      <t>In this document we use a new AFI/SAFI instead of re-using SAFI 128
      to carry these transport-routes, because it is operationally
      advantageous to keep transport and service prefixes separate, and not
      mix in same address-family or rib. E.g. it allows to safely enable
      per-prefix-label allocation for transport-VPN prefixes while not
      affecting SAFI 128 service-prefixes which have huge-scale. Also,
      re-advertisement path of transport-family routes in a network would be
      different than service-route readvertisement path. viz. Service-routes
      are exchanged over a EBGP multihop session between Autonomous-systems
      with nexthop unchanged; where-as transport-VPN routes are readvertised
      over EBGP single-hop sessions with nexthop-self rewrite over inter-AS
      links.</t>

      <t>This family TransportVpn is similar in vein to BGP-LU, in that it
      carries transport prefixes. The only difference is, it also carries in
      Route Target an indication of which transport class the transport prefix
      belongs to, and has means, such as RD, to disambiguate multiple instances
      of the same transport prefix when carried in BGP update messages. </t>
    </section>

    <section title="Protocol Procedures">
      <t>This section summarizes the procedures followed by various nodes
      speaking Transport-VPN family</t>

      <t>Preparing the network for deploying Transport-VPNs</t>

      <t><list>
          <t>Operator decides on the transport classes that exist in the
          network, and allocates a Route-Target to identify each transport
          class.</t>

          <t>Operator configures transport classes on the SNs and BNs in the
          network with unique Route-Distinguishers and Route-Targets.</t>

          <t>Implementations may provide automatic generation and assignment of
          RD, RT values for a transport routing instance; they should also
          provide a way to manually override the automatic mechanism, in order
          to deal with any conflicts that may arise with existing RD, RT values
          in the network.</t>
        </list></t>

      <t>Origination of Transport-VPN route:</t>

      <t><list>
          <t>At the ingress node of the tunnel's egress domain, the tunneling
          protocols install routes in the transport RIB associated with the
          transport class the tunnel belongs to. The ingress node then
          advertises this tunnel route into BGP as a Transport-VPN route with
          NLRI RD:TunnelEndpoint, attaching a Route-Target that identifies the
          transport class.</t>

          <t>Alternatively, the egress node of the tunnel i.e. the tunnel
          endpoint can originate the BGP Transport-VPN route, with NLRI
          RD:TunnelEndpoint and PNH TunnelEndpoint, which will resolve over the
          tunnel route at the ingress node. When the tunnel is up, the
          Transport-VPN route will become usable and get re-advertised.</t>
        </list></t>

      <t>Ingress node receiving transport-VPN route<list>
          <t>On receiving a BGP transport-vpn route with a PNH that is not
          directly connected, e.g. an IBGP-route, the Route-Target on the
          route indicates which transport class this route belongs to. The
          routes in the associated transport RIB are used to resolve the
          received PNH. If there does not exist a route in the transport RIB
          for the PNH, the transport-vpn route is considered unusable, and
          MUST not be re-advertised further.</t>
        </list></t>

      <t>Border node readvertising transport-VPN route with nexthop self:<list>
          <t>The BN allocates an MPLS label to advertise upstream in
          transport-vpn NLRI. The BN also installs an MPLS swap-route for that
          label that pops the label and pushes received traffic to the
          transport tunnel or direct interface that the transport-vpn route's
          PNH resolved over.</t>
        </list></t>

      <t>Border node receiving transport-VPN route on EBGP :<list>
          <t>If the route is received with PNH that is known to be directly
          connected, e.g. EBGP single-hop peering address, the directly
          connected interface is checked for MPLS forwarding capability. No
          other nexthop resolution process is performed, as the inter-AS link
          can be used for any transport class.</t>

          <t>If the inter-AS links should honor transport class, then the BN
          should follow procedures of an Ingress node described above, and
          perform nexthop resolution process. The interface routes should be
          installed in the transport rib belonging to the associated
          transport class.</t>
        </list></t>

      <t>Avoiding path-hiding through Route Reflectors<list>
          <t>When multiple BNs exist that advertise a RDn:PEn prefix to RRs,
          the RRs may hide all but one of the BNs, unless [ADDPATH] is used
          for the Transport-VPN family. This is similar to L3VPN option-B
          scenarios. Hence [ADDPATH] should be used for Transport-VPN family,
          to avoid path-hiding through RRs.</t>
        </list></t>

      <t>Ingress node receiving service route with mapping community<list>
          <t>Service routes received with mapping community resolve using
          transport RIB associated with the mapped transport class. If the
          resolution process does not find an usable transport VPN route or
          tunnel route, the service route MUST be considered unusable for
          forwarding purpose.</t>
        </list></t>

      <t>Coordinating between domains using different community
      namespaces.<list>
          <t>Domains not agreeing on RT, RD, Mapping-community values because
          of independently administered community namespaces may deploy
          mechanisms to map and rewrite the Route-target values on domain
          boundaries, using per ASBR import policies. This is no different
          than any other BGP VPN family. The mechanisms employed in inter-AS
          VPN deployments may be used with the transport-vpn family also.</t>

          <t>Though RD can also be rewritten on domain boundaries, we recommend
          deploying unique RDs, because it helps in trouble-shooting by uniquely
          identifying originator of a route, and avoids path-hiding.</t>
        </list></t>
    </section>

    <section title="OAM considerations">
      <t>TBD</t>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t>This document makes following requests of IANA.</t>

      <t>New BGP SAFI code for "Transport-VPN". Value 75.</t>

      <t>This will be used to create new AFI,SAFI pairs for IPv4, IPv6
      Transport-Vpn families. viz:</t>

      <t><list style="symbols">
          <t>"Inet, Transport-Vpn". AFI/SAFI = "1/75" for carrying IPv4
          transport-VPN prefixes.</t>

          <t>"Inet6, Transport-Vpn". AFI/SAFI = "2/75" for carrying IPv6
          transport-VPN prefixes.</t>
        </list></t>

      <t>Note to RFC Editor: this section may be removed on publication as an
      RFC.</t>
    </section>

    <section anchor="Security" title="Security Considerations">
      <t>Mechanisms described in this document dont have any adverse impact on
      security of a network.</t>
    </section>

    <section anchor="Acknowledgements" title="Acknowledgements">
      <t>The authors thank Jeff Haas, John Scudder, Navaneetha Krishnan, Ravi
      M R, Chandrasekar Ramachandran, Shradha Hegde, Richard Roberts,
      Krzysztof Szarkowicz, John E Drake, Srihari Sangli, Vijay Kestur,
      Santosh Kolenchery for the valuable discussions.</t>

      <t>The decision to not reuse SAFI 128 and create a new address-family to
      carry these transport-routes was based on suggestion made by Richard
      Roberts and Krzysztof Szarkowicz.</t>
    </section>

    <section anchor="References" title="References">
      <t>[RFC-4364] BGP/MPLS IP Virtual Private Networks (VPNs)</t>

      <t>[RFC-8277] Using BGP to Bind MPLS Labels to Address Prefixes</t>

      <t>[ADDPATH] RFC-7911 - Advertisement of Multiple Paths in BGP</t>

      <t>[BGP-SRTE] Advertising Segment Routing Policies in BGP,
      draft-ietf-idr-segment-routing-te-policy-08</t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      <?rfc include="reference.RFC.2119"?>
    </references>
  </back>
</rfc>
